### 文件IO

> Linux系统调用

Linux系统调用(system call)是指操作系统提供给用户程序的一组“特殊接口”，用户程序可以通过这组“特殊”接口来获得操作系统提供的特殊服务。

为了更好的保护内核空间，将程序的运行空间分为内核空间和用户空间，他们运行在不同的级别上，在逻辑上是相互隔离的。在Linux中，用户程序不能直接访问内核提供的服务，必须通过系统调用来使用内核提供的服务。

Linux中的用户编程接口(API)遵循了UNIX中最流行的应用编程界面标准——POSIX。这些系统调用编程接口主要是通过C库(libc)实现的。

> 文件描述符

对内核而言，所有打开文件都由文件描述符引用。文件描述符是一个非负整数。当打开一个现存文件或创建一个新文件时，内核向进程返回一个文件描述符。当写一个文件时，用open或create返回的文件描述符标识该文件，将其作为参数传送给read或write。

在POSIX应用程序中，整数0、1、2应被代换成符号常数：
	1. STDIN_FILENO（标准输入，默认是键盘）
	2. STDOUT_FILENO（标准输出，默认是屏幕）
	3. STDERR_FILENO（标准错误输出，默认是屏幕）

这里常数都定义在头文件`<unistd.h>`中，文件描述符的范围是0~OPEN_MAX。早期的UNIX版本采用的上限值是19（允许每个进程打开20个文件），现在很多系统则将其增加到256.

可用的文件I\O函数很多，包括：打开文件，读文件，写文件等。大多数Linux文件I\O只需要用到5个函数：open, read, write, lseek以及close。

> 基本API

##### open

需要包含的头文件：`<sys/types.h>, <sys/stat.h>, <fcntl.h>`

函数原型：

```
int open(const str * pathname, int oflag, [..., mode_t mode])
```

功能：打开文件

返回值：成功则返回文件描述符，出错返回-1

参数：
1. pathname：打开或创建的文件的全路径名
2. oflag：可用来说明此函数的多个选择项，详见后
3. mode：对于open函数而言，仅当创建新文件时才使用第三个参数，表示新建文件的权限设置

```
详解oflag参数：
oflag参烽由O_RDONLY(只读打开)、O_WRONLY(只写打开)、O_RDWR(读写打开)中的一个与下列一个或多个常数

O_APPEND：追加到文件尾
O_CREAT：若文件不存在则创建它。使用此选择项时，需同时说明第三个参数mode，用其说明新文件的访问权限
O_EXCL：如果同时指定O_CREAT，而该文件又是存在的，报错；也可以测试一个文件是否存在，不存在则创建
O_TRUNC：如果此文件存在，而且为读写或只写成功打开，则将其长度截短为0
O_SYNC：使每次write都等到物理I\O操作完成
```

##### read

需要包含的头文件：`<unistd.h>`

函数原型：

```
ssize_t read(int fd, void * buf, size_t  count)
```

功能：从打开的文件中读取数据

返回值：实际读到的字节数；已读取文件尾返回0，出错的话返回-1，ssize_t是系统头文件中用typedef定义的数据类型相当于signed int

参数：
1. fd：要读取的文件的描述符
2. buf：得到的数据在内存中的位置的首地址
3. count：期望本次能读取到的最大字节数。size_t是系统头文件中用typedef定义的数据类型，相当于unsigned int


